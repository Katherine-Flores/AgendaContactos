<!DOCTYPE html> 
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Agenda de Contactos</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="	https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="d-flex justify-content-center align-items-center" style="height: 100vh;">
  <div class="container shadow-lg p-0" id="contenedor-principal">
    <div class="row align-items-stretch">
      <div class="col-md-6 pt-4 pb-4" id="contenedor-registro">
        <div class="container text-center h-100 pt-4 pb-4" id="mensaje-registro" style="display: block;">
          <div class="d-flex flex-column h-100">
            <div>
              <h1>¡Hola!</h1>
              <p>Bienvenido de nuevo. Tu red de contactos, siempre a tu alcance.</p>
            </div>
            <div class="flex-grow-1"></div>
            <div>
              <label class="col-md-12 text-start">¿Aún no tienes una cuenta?</label>
              <button class="btn-toggle w-100" type="button" onclick="toggleregistro()">REGISTRARSE</button>
            </div>
          </div>
        </div>
        <div class="container pt-4 pb-4" id="formulario-registro" style="display: none;">

          <form id="registerForm" class="row needs-validation" novalidate>

            <h5>Registro</h5>

            <div class="col-md-12 mt-2">
              <label for="usuario-registro" class="form-label">Usuario</label>
              <input type="text" class="form-control" id="usuario-registro" name="nombre_usuario" required>
              <div class="invalid-feedback">
                usuario requerido.
              </div>
            </div>

            <div class="col-md-12 mt-2">
              <label for="pass-registro" class="form-label">Contraseña</label>
              <input type="password" class="form-control" id="pass-registro" name="contrasena" required>
              <div class="invalid-feedback">
                Porfavor, ingrese su contraseña.
              </div>
            </div>

            <div class="col-md-12 mt-2">
              <label for="confim-registro" class="form-label">Confirmar Contraseña</label>
              <input type="password" class="form-control" id="confim-registro" name="contrasenaconfirm" required>
              <div class="invalid-feedback">
                Porfavor, confirme su contraseña.
              </div>
            </div>

            <div class="col-md-12 mt-3">
              <button class="btn-form w-100" type="submit">REGISTRARSE</button>
            </div>

            <div>
              <button class="link-button mt-3" type="button" onclick="togglelogin()">¿Ya tienes una cuenta?</button>
            </div>
          </form>

        </div>

      </div>
      <div class="col-md-6 pt-4 pb-4" style="background-color: white;" id="contenedor-login">

        <div class="container text-center h-100 pt-4 pb-4" id="mensaje-login" style="display: none;">
          <div class="d-flex flex-column h-100">
            <div>
              <h2>Crea tu cuenta</h2>
              <p>Mantente en contacto con las personas que más importan.</p>
            </div>
            <div class="flex-grow-1"></div>
            <div>
              <label class="col-md-12 text-start">¿Ya tienes una cuenta?</label>
              <button class="btn-toggle w-100" type="button" onclick="togglelogin()">INICIAR SESIÓN</button>
            </div>
          </div>
        </div>

        <div class="container pt-4 pb-4" id="formulario-login" style="display: block;">

          <form id="loginForm" class="row needs-validation" novalidate>

            <h5>INICIO DE SESIÓN</h5>

            <div class="col-md-12 mt-2">
              <label for="validationCustom01" class="form-label">Usuario</label>
              <input type="text" class="form-control" id="validationCustom01" name="nombre_usuario_login" required>
              <div class="invalid-feedback">
                usuario requerido.
              </div>
            </div>

            <div class="col-md-12 mt-2">
              <label for="validationCustom02" class="form-label">Contraseña</label>
              <input type="password" class="form-control" id="validationCustom02" name="contrasena_login" required>
              <div class="invalid-feedback">
                Porfavor, ingrese su contraseña.
              </div>
            </div>
            
            <div class="col-md-12 mt-3">
              <button class="btn-form w-100" type="submit">INICIAR SESIÓN</button>
            </div>

            <div>
              <button class="link-button mt-3" type="button" onclick="toggleregistro()">¿Aún no tienes una cuenta?</button>
            </div>

          </form>
        </div>

      </div>
    </div>
  </div>

  <div id="resultado"></div>

<script>
  const registerForm = document.getElementById('registerForm');
  const loginForm = document.getElementById('loginForm');

  // Validar contraseña segura
  function validarContrasenaFuerte(pass) {
    const regex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[\W_]).{6,}$/;
    return regex.test(pass);
  }

  registerForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const usuario = registerForm.nombre_usuario.value;
    const pass = registerForm.contrasena.value;
    const confirm = document.getElementById('confim-registro').value;

    if (pass !== confirm) {
      Swal.fire('Error', 'Las contraseñas no coinciden', 'error');
      return;
    }

    if (!validarContrasenaFuerte(pass)) {
      Swal.fire('Error', 'La contraseña debe tener mayúsculas, minúsculas, número y símbolo', 'error');
      return;
    }

    const res = await fetch('http://localhost:3000/api/auth/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ nombre_usuario: usuario, contrasena: pass })
    });

    const json = await res.json();

    if (res.ok) {
      Swal.fire('¡Registro exitoso!', json.message, 'success');
      registerForm.reset();
    } else {
      Swal.fire('Error', json.error || 'No se pudo registrar', 'error');
    }
  });

  loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = new FormData(loginForm);
    const res = await fetch('http://localhost:3000/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        nombre_usuario: data.get('nombre_usuario_login'),
        contrasena: data.get('contrasena_login')
      })
    });
    const json = await res.json();

    if (res.ok) {
      localStorage.setItem('token', json.token);
      console.log('TOKEN GUARDADO:', localStorage.getItem('token'));

      Swal.fire({
        title: '¡Login exitoso!',
        text: json.message,
        icon: 'success',
        confirmButtonText: 'Ir al Dashboard'
      }).then(() => {
        window.location.href = 'dashboard.html';
      });
    } else {
      Swal.fire('Error', json.error || 'No se pudo iniciar sesión', 'error');
    }
  });
</script>

<!-- Script Bootstrap Validacion -->
<script>
  // Example starter JavaScript for disabling form submissions if there are invalid fields
  (() => {
    'use strict'

    // Fetch all the forms we want to apply custom Bootstrap validation styles to
    const forms = document.querySelectorAll('.needs-validation')

    // Loop over them and prevent submission
    Array.from(forms).forEach(form => {
      form.addEventListener('submit', event => {
        if (!form.checkValidity()) {
          event.preventDefault()
          event.stopPropagation()
        }

        form.classList.add('was-validated')
      }, false)
    })
  })()
</script>

<!-- Script de style -->
<script>
  const rootStyles = getComputedStyle(document.documentElement);
  const azulOscuro = rootStyles.getPropertyValue('--azul-oscuro').trim();
  const azulMedio = rootStyles.getPropertyValue('--azul-medio').trim();
  const azulClaro = rootStyles.getPropertyValue('--azul-claro').trim();
  const fondoClaro = rootStyles.getPropertyValue('--fondo-claro').trim();

  function esPantallaPequena() {
    return window.innerWidth <= 900;
  }

  function toggleregistro() {
    const mensaje = document.getElementById("mensaje-registro");
    const formulario = document.getElementById("formulario-registro");
    const contenedor = document.getElementById("contenedor-registro");
    const mensaje2 = document.getElementById("mensaje-login");
    const formulario2 = document.getElementById("formulario-login");
    const contenedor2 = document.getElementById("contenedor-login");

    if (esPantallaPequena()) {
      // En móviles/tablets solo se muestra el formulario de registro
      mensaje.style.display = 'none';
      formulario.style.display = 'block';
      contenedor.style.display = 'block';

      mensaje2.style.display = 'none';
      formulario2.style.display = 'none';
      contenedor2.style.display = 'none';
    } else {
      // En pantallas grandes, se muestran ambos lados
      mensaje.style.display = 'none';
      formulario.style.display = 'block';
      contenedor.style.display = 'block';
      contenedor.style.backgroundColor = 'white';
      contenedor.style.color = azulOscuro;

      mensaje2.style.display = 'block';
      formulario2.style.display = 'none';
      contenedor2.style.display = 'block';
      contenedor2.style.backgroundColor = azulMedio;
      contenedor2.style.color = 'white';
    }
  }

  function togglelogin() {
    const mensaje = document.getElementById("mensaje-login");
    const formulario = document.getElementById("formulario-login");
    const contenedor = document.getElementById("contenedor-login");
    const mensaje2 = document.getElementById("mensaje-registro");
    const formulario2 = document.getElementById("formulario-registro");
    const contenedor2 = document.getElementById("contenedor-registro");

    if (esPantallaPequena()) {
      // En móviles/tablets solo se muestra el formulario de login
      mensaje.style.display = 'none';
      formulario.style.display = 'block';
      contenedor.style.display = 'block';

      mensaje2.style.display = 'none';
      formulario2.style.display = 'none';
      contenedor2.style.display = 'none';
    } else {
      // En pantallas grandes, se muestran ambos lados
      mensaje.style.display = 'none';
      formulario.style.display = 'block';
      contenedor.style.display = 'block';
      contenedor.style.backgroundColor = 'white';
      contenedor.style.color = azulOscuro;

      mensaje2.style.display = 'block';
      formulario2.style.display = 'none';
      contenedor2.style.display = 'block';
      contenedor2.style.backgroundColor = azulMedio;
      contenedor2.style.color = 'white';
    }
  }

  window.addEventListener('DOMContentLoaded', () => {
    const mensaje = document.getElementById("mensaje-login");
    const formulario = document.getElementById("formulario-login");
    const contenedor = document.getElementById("contenedor-login");
    const mensaje2 = document.getElementById("mensaje-registro");
    const formulario2 = document.getElementById("formulario-registro");
    const contenedor2 = document.getElementById("contenedor-registro");

    if (esPantallaPequena()) {
      // En móviles solo mostrar login
      mensaje.style.display = 'none';
      formulario.style.display = 'block';
      contenedor.style.display = 'block';

      mensaje2.style.display = 'none';
      formulario2.style.display = 'none';
      contenedor2.style.display = 'none';
    } else {
      // En pantallas grandes, mostrar login con mensaje y registro con mensaje
      mensaje.style.display = 'none';
      formulario.style.display = 'block';
      contenedor.style.display = 'block';
      contenedor.style.backgroundColor = 'white';
      contenedor.style.color = azulOscuro;

      mensaje2.style.display = 'block';
      formulario2.style.display = 'none';
      contenedor2.style.display = 'block';
      contenedor2.style.backgroundColor = azulMedio;
      contenedor2.style.color = 'white';
    }
  });
</script>
</body>
</html>
